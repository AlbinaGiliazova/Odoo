<?xml version="1.0" encoding="UTF-8"?>
<odoo>
    <!-- Дерево заданий на упаковку -->
    <record id="view_packing_order_list" model="ir.ui.view">
    <field name="name">packing.order.list</field>
    <field name="model">packing.order</field>
    <field name="arch" type="xml">
        <list>
            <field name="name" string="Название"/>
            <field name="state" widget="badge" options="{'style': 'color'}" string="Статус"/>
            <field name="user_id" string="Пользователь"/>
            <field name="full_packing_date" string="Дата полной упаковки"/>
        </list>
    </field>
    </record>

    <!-- Форма задания на упаковку -->
    <record id="view_packing_order_form" model="ir.ui.view">
        <field name="name">packing.order.form</field>
        <field name="model">packing.order</field>
        <field name="arch" type="xml">
            <form string="Задание на упаковку">
                <sheet>
                    <group>
                        <field name="name" string="Название"/>
                        <field name="state" readonly="1" string="Статус"/>
                        <field name="user_id" string="Пользователь"/>
                        <field name="full_packing_date" string="Дата полной упаковки"/>
                    </group>
                    <notebook>
                        <page string="Детали заказа">
                            <field name="line_ids">
                                <list editable="bottom">
                                    <field name="product_id" string="Деталь"/>
                                    <field name="product_id_int" string="ID детали"/>
                                    <field name="product_qty" string="Нужно"/>
                                    <field name="packed_qty" string="Упаковано"/>
                                </list>                                
                            </field>
                            <button
                                name="action_open_packing_process"
                                type="object"
                                string="Открыть процесс упаковки"
                                class="btn-primary"/>
                            <button name="action_start_packing"
                                type="object"
                                string="Начать упаковку"
                                class="btn-primary"
                                invisible="state != 'draft'"/>
                            <button name="action_cancel_order"
                                type="object"
                                string="Отменить"
                                class="btn-secondary"
                                invisible="state == 'cancel'"/>
                            <button name="action_mark_done"
                                type="object"
                                string="Завершить"
                                class="btn-success"/>
                        </page>
                    </notebook>
                    <footer>
                        <button name="action_start_packing"
                                type="object"
                                string="Начать упаковку"
                                class="btn-primary"
                                invisible="state != 'draft'"/>
                        <button name="action_cancel_order"
                                type="object"
                                string="Отменить"
                                class="btn-secondary"
                                invisible="state == 'cancel'"/>
                        <button name="action_mark_done"
                                type="object"
                                string="Завершить"
                                class="btn-success"
                                invisible="state != 'in_progress'"/>
                        <button
                                name="action_open_packing_process"
                                type="object"
                                string="Открыть процесс упаковки"
                                class="btn-primary"/>
                    </footer>
                    <field name="state" invisible="1"/>
                </sheet>
            </form>
        </field>
    </record>

    <record id="view_packing_process_form" model="ir.ui.view">
    <field name="name">packing.order.packing_process.form</field>
    <field name="model">packing.order</field>
    <field name="priority">20</field>
    <field name="arch" type="xml">
        <form string="Процесс упаковки">
            <sheet>
                <group>
                    <field name="barcode_scanner" widget="barcode_scanner_widget"
                           placeholder="Введите ID продукта и нажмите Enter"/>
                </group>
                <field name="line_ids">
                    <list editable="bottom">
                        <field name="product_id"/>
                        <field name="product_qty"/>
                        <field name="packed_qty"/>
                        <field name="state" widget="badge" options="{'style': 'color'}"/>
                    </list>
                </field>
                    <button name="action_mark_done"
                            type="object"
                            string="Завершить упаковку"
                            class="btn-success"/>
                    <button name="action_cancel_order"
                            type="object"
                            string="Отменить"
                            class="btn-secondary"/>
                <footer>
                    <button name="action_mark_done"
                            type="object"
                            string="Завершить упаковку"
                            class="btn-success"
                            invisible = "state != 'in_progress'"/>
                    <button name="action_cancel_order"
                            type="object"
                            string="Отменить"
                            class="btn-secondary"/>
                </footer>
                <field name="state" invisible="1"/>
            </sheet>
        </form>
    </field>
    </record>

    <!-- Действие окна -->
    <record id="action_packing_order" model="ir.actions.act_window">
        <field name="name">Задания на упаковку</field>
        <field name="res_model">packing.order</field>
        <field name="view_mode">list,form</field>
    </record>

    <record id="action_import_packing_csv" model="ir.actions.act_window">
    <field name="name">Импорт из CSV</field>
    <field name="res_model">import.packing.csv.wizard</field>
    <field name="view_mode">form</field>
    <field name="view_id" ref="view_import_packing_csv_wizard"/>
    <field name="target">new</field>
    </record>

    <!-- Меню в разделе Склад -->
    <menuitem 
        id="menu_packing_root"
        name="Упаковка"
        parent="stock.menu_stock_root"/>

    <menuitem
        id="menu_packing_order"
        name="Задания на упаковку"
        parent="menu_packing_root"
        action="action_packing_order"/>

    <menuitem
       id="menu_import_packing_csv"
       name="Импорт из CSV"
       parent="menu_packing_root"
       action="action_import_packing_csv"/>

    <record id="action_packing_process" model="ir.actions.act_window">
        <field name="name">Процесс упаковки</field>
        <field name="res_model">packing.order</field>
        <field name="view_mode">form</field>
        <field name="view_id" ref="view_packing_process_form"/>
        <field name="target">current</field>
    </record>

    <menuitem id="menu_packing_process"
    name="Процесс упаковки"
    parent="menu_packing_root"
    action="action_packing_process"/>

</odoo>